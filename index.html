<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Truck Driver Leave</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Optional: set content to full API root when hosting frontend separately -->
  <meta name="atc-api-base" content="https://autocash.my/atc/public" />
  <style>
    .chip{ @apply inline-flex items-center px-2 py-1 text-xs rounded bg-gray-100; }
    .chip-full{ @apply bg-red-100 text-red-700; }
    .chip-ok{ @apply bg-green-100 text-green-700; }
    .chip-mid{ @apply bg-amber-100 text-amber-700; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-4xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">Truck Driver Leave</h1>
      <p class="text-sm text-slate-500">Asia/Kuala_Lumpur timezone</p>
    </header>

    <!-- Driver Form -->
    <section class="bg-white rounded-2xl shadow p-5 mb-6">
      <h2 class="font-semibold mb-4">Apply for Leave</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm">Driver</span>
          <select id="driverSelect" class="mt-1 w-full border rounded p-2"></select>
        </label>
        <div class="grid grid-cols-2 gap-4 col-span-2">
          <label class="block">
            <span class="text-sm">Start</span>
            <input id="dateStart" type="date" class="mt-1 w-full border rounded p-2"/>
          </label>
          <label class="block">
            <span class="text-sm">End</span>
            <input id="dateEnd" type="date" class="mt-1 w-full border rounded p-2"/>
          </label>
        </div>
      </div>

      <div id="capacityHints" class="mt-4 flex flex-wrap gap-2"></div>

      <div class="mt-4 flex items-center gap-3">
        <button id="btnSubmit" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Submit</button>
        <span id="status" class="text-sm text-slate-500"></span>
      </div>

      <p class="text-xs text-slate-500 mt-3">
        Max 3 drivers per day. If any selected day is full (you'd be the 4th), you'll be asked whether to
        <b>force 3 consecutive working days</b> starting from your start date (weekends not counted).
      </p>
    </section>

    <!-- Screenshots after submit -->
    <section id="screenshots" class="bg-white rounded-2xl shadow p-5 mb-6 hidden">
      <h2 class="font-semibold mb-4">Calendar Snapshots</h2>
      <div class="grid md:grid-cols-2 gap-6" id="shotsGrid"></div>
    </section>

    <!-- Admin Panel -->
    <section class="bg-white rounded-2xl shadow p-5">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">Admin</h2>
        <button id="toggleAdmin" class="text-blue-600 text-sm">Show/Hide</button>
      </div>
      <div id="adminBody" class="mt-4 hidden">
        <div class="grid md:grid-cols-3 gap-4">
          <label class="block">
            <span class="text-sm">Admin API Key</span>
            <input id="adminKey" type="password" value="a63b18e7b18d3291057cbcdb6c055d60f0d%d6fd^$99fac158b447dc88801f677" disabled class="mt-1 w-full border rounded p-2" placeholder="Paste key for admin calls"/>
          </label>
          <label class="block">
            <span class="text-sm">Calendar ID</span>
            <input id="calendarId" class="mt-1 w-full border rounded p-2" placeholder="primary or calendar id"/>
          </label>
          <label class="block">
            <span class="text-sm">Weekend days (CSV of 0-6)</span>
            <input id="weekendDays" class="mt-1 w-full border rounded p-2" placeholder="6,0"/>
          </label>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="btnSaveSettings" class="px-3 py-2 rounded bg-slate-800 text-white">Save Settings</button>
          <button id="btnReloadDrivers" class="px-3 py-2 rounded bg-slate-800 text-white">Reload Drivers</button>
        </div>

        <h3 class="font-semibold mt-6">Driver List</h3>
        <table class="w-full text-sm border mt-2" id="driversTable">
          <thead>
            <tr class="bg-slate-100">
              <th class="p-2 border">Name</th>
              <th class="p-2 border">Category</th>
              <th class="p-2 border">Active</th>
              <th class="p-2 border">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="mt-3 flex gap-2">
          <button id="btnAddDriver" class="px-3 py-2 rounded bg-blue-600 text-white">Add Driver</button>
          <button id="btnSaveDrivers" class="px-3 py-2 rounded bg-green-600 text-white">Save Changes</button>
          <button id="btnResetFromServer" class="px-3 py-2 rounded bg-slate-600 text-white">Reload From Server</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Force-3 Modal -->
  <div id="forceModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-6">
    <div class="bg-white max-w-md w-full rounded-2xl p-6">
      <h3 class="font-semibold text-lg">Daily Limit Reached</h3>
      <p class="mt-2 text-sm">
        One or more selected days is already at 3 drivers. Do you want to apply
        <b>3 consecutive working days</b> starting from your <b>start date</b> (weekends not counted)?
      </p>
      <div class="mt-4 flex gap-2 justify-end">
        <button id="btnCancelForce" class="px-3 py-2 rounded bg-slate-200">Cancel</button>
        <button id="btnConfirmForce" class="px-3 py-2 rounded bg-blue-600 text-white">Yes, apply 3 days</button>
      </div>
    </div>
  </div>

  <script>
  // ====== CONFIG ======
  const ADMIN_KEY = "a63b18e7b18d3291057cbcdb6c055d60f0d%d6fd^$99fac158b447dc88801f677";
  const DEFAULT_API_BASE = '/atc/public';
  const API_BASE = (() => {
    const fromWindow = typeof window.ATC_API_BASE === 'string' ? window.ATC_API_BASE.trim() : '';
    const fromMeta = (document.querySelector('meta[name=\"atc-api-base\"]')?.content || '').trim();
    const selected = fromWindow || fromMeta || DEFAULT_API_BASE;
    return selected.replace(/\s+/g, '');
  })();
  const API_BASE_IS_ABSOLUTE = /^https?:\/\//i.test(API_BASE);
  const NORMALIZED_API_BASE = (() => {
    const trimmed = API_BASE.replace(/\/+$/, '');
    if (API_BASE_IS_ABSOLUTE) {
      return trimmed;
    }
    const prefixed = trimmed.startsWith('/') ? trimmed : `/${trimmed}`;
    return `${window.location.origin}${prefixed}`;
  })();
  const TIMEZONE = 'Asia/Kuala_Lumpur';

  // ====== STATE ======
  let DRIVERS = [];
  let WEEKEND = [6,0];
  let SELECTED = { start:null, end:null };
  let HAS_FULL_DAY = false; // track capacity errors
  let PENDING_FORCE_START = null;

  // ====== HELPERS ======
  const qs = (s,p=document) => p.querySelector(s);
  const qsa = (s,p=document) => Array.from(p.querySelectorAll(s));
  const fmt = d => d.toISOString().slice(0,10);
  const isoToMonth = d => d.slice(0,7);
  const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };

  function toast(msg, kind='info'){
    const el = document.createElement('div');
    el.className = 'fixed bottom-4 right-4 bg-slate-900 text-white px-3 py-2 rounded shadow';
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(()=> el.remove(), 3000);
  }

  const normalizeDriver = (d) => ({
    driver_id: d.driver_id || d.driverId || '',
    display_name: d.display_name || d.displayName || '',
    category: d.category || 'trailer',
    active: d.active !== false,
    updated_at: d.updated_at || d.updatedAt || null
  });

  const resolveUrl = (endpoint) => {
    const path = endpoint.startsWith('/') ? endpoint.slice(1) : endpoint;
    const base = NORMALIZED_API_BASE.endsWith('/') ? NORMALIZED_API_BASE : `${NORMALIZED_API_BASE}/`;
    return new URL(path, base);
  };

  async function handleResponse(res){
    const text = await res.text();
    let data = {};
    if(text){
      try{
        data = JSON.parse(text);
      }catch(err){
        console.error('Failed to parse JSON response', err);
      }
    }
    if(!res.ok){
      const message = (data && data.message) || `Request failed (${res.status})`;
      throw new Error(message);
    }
    return data;
  }

  async function apiGet(endpoint, params={}){
    const url = resolveUrl(endpoint);
    Object.entries(params).forEach(([k,v])=>{
      if(v !== undefined && v !== null){
        url.searchParams.append(k, v);
      }
    });
    const res = await fetch(url.toString(), {
      method:'GET',
      headers:{ 'Accept':'application/json' },
      credentials:'same-origin'
    });
    return handleResponse(res);
  }

  async function apiPost(endpoint, body={}){
    const url = resolveUrl(endpoint);
    const res = await fetch(url.toString(), {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Accept':'application/json'
      },
      credentials:'same-origin',
      body: JSON.stringify(body)
    });
    return handleResponse(res);
  }

  function renderDrivers(){
    const sel = qs('#driverSelect');
    sel.innerHTML = '';
    DRIVERS.filter(d=> d.active !== false).forEach(d=>{
      const opt = document.createElement('option');
      opt.value = d.driver_id || '';
      const name = d.display_name || d.driver_id || 'Unnamed Driver';
      opt.textContent = `${name}${d.category ? ` (${d.category})` : ''}`;
      sel.appendChild(opt);
    });
    if(!sel.value && sel.options.length){
      sel.value = sel.options[0].value;
    }
  }

  function renderDriversTable(){
    const tb = qs('#driversTable tbody');
    tb.innerHTML='';
    DRIVERS.forEach((d, idx)=>{
      const name = d.display_name || '';
      const category = d.category || 'trailer';
      const checked = d.active ? 'checked' : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border p-2"><input data-k="display_name" data-i="${idx}" class="w-full border rounded p-1" value="${name}"></td>
        <td class="border p-2">
          <select data-k="category" data-i="${idx}" class="w-full border rounded p-1">
            ${['trailer','12w','lowbed'].map(c=>`<option ${category===c?'selected':''} value="${c}">${c}</option>`).join('')}
          </select>
        </td>
        <td class="border p-2 text-center"><input type="checkbox" data-k="active" data-i="${idx}" ${checked}></td>
        <td class="border p-2 text-center"><button data-act="del" data-i="${idx}" class="text-red-600">Delete</button></td>`;
      tb.appendChild(tr);
    });
    // bind change handlers and delete
    qsa('#driversTable [data-act="del"]').forEach(btn=>{
      btn.onclick = ()=>{ DRIVERS.splice(+btn.dataset.i,1); renderDriversTable(); };
    });
  }

  function addDriverRow(){
    DRIVERS.push({ driver_id: 'DRV-'+Math.random().toString(36).slice(2,8), display_name:'', category:'trailer', active:true });
    renderDriversTable();
  }

  function collectSelectedDates(){
    if(!SELECTED.start || !SELECTED.end) return [];
    const out=[]; let d=new Date(SELECTED.start);
    const end=new Date(SELECTED.end);
    while(d<=end){ out.push(fmt(d)); d=addDays(d,1); }
    return out;
  }

  async function refreshCapacityHints(){
    const dates = collectSelectedDates();
    const hint = qs('#capacityHints');
    hint.innerHTML = '';
    if(dates.length===0) return;
    const from = dates[0]; const to = dates[dates.length-1];
    HAS_FULL_DAY = false;
    try{
      const data = await apiGet('capacity', { from, to });
      const counts = data.counts || {};
      dates.forEach(ds=>{
        const n = counts[ds] || 0;
        if(n>=3) HAS_FULL_DAY = true;
        const span = document.createElement('span');
        span.className = 'chip ' + (n>=3? 'chip-full' : (n===2? 'chip-mid':'chip-ok'));
        span.textContent = `${ds}: ${n}/3`;
        hint.appendChild(span);
      });
    }catch(err){
      console.error(err);
      toast('Failed to load capacity: '+err.message);
    }
  }

  async function loadDrivers(){
    try{
      const data = await apiGet('drivers');
      DRIVERS = (data.drivers || []).map(normalizeDriver);
      WEEKEND = data.weekend_days || data.weekendDays || [6,0];
      renderDrivers();
      renderDriversTable();
      if(Array.isArray(WEEKEND)){
        qs('#weekendDays').value = WEEKEND.join(',');
      }
    }catch(err){
      console.error(err);
      toast(`Failed to load drivers: ${err.message}`);
    }
  }

  async function submitForm(){
    const driver_id = qs('#driverSelect').value;
    if(!driver_id){ toast('Select a driver'); return; }
    if(!SELECTED.start || !SELECTED.end){ toast('Choose start & end'); return; }

    // Try normal range apply
    let res;
    try{
      res = await apiPost('apply', { driver_id, start_date: SELECTED.start, end_date: SELECTED.end });
    }catch(err){
      toast('Submit failed: '+err.message);
      return;
    }
    if(res.ok){
      toast(`Applied for ${res.applied_dates.length} day(s)`,'ok');
      await afterApplied(res.applied_dates);
    } else {
      if(res.errors){
        // if any full day, offer force-3 starting from start
        PENDING_FORCE_START = SELECTED.start;
        qs('#forceModal').classList.remove('hidden');
      } else {
        toast('Failed: '+(res.message||''));
      }
    }
    await refreshCapacityHints();
  }

  async function confirmForce(){
    if(!PENDING_FORCE_START){
      toast('No force request pending');
      return;
    }
    const driver_id = qs('#driverSelect').value;
    let res;
    try{
      res = await apiPost('apply_force3', { driver_id, start_date: PENDING_FORCE_START });
    }catch(err){
      toast('Force failed: '+err.message);
      return;
    }
    if(res.ok){
      toast(`Forced 3 working days: ${res.applied_dates.join(', ')}`);
      qs('#forceModal').classList.add('hidden');
      PENDING_FORCE_START = null;
      await afterApplied(res.applied_dates);
      await refreshCapacityHints();
    } else {
      toast('Force failed: '+(res.message||''));
    }
  }

  async function afterApplied(dates){
    try{
      // Show calendar screenshots for current and next month if any events exist
      const months = Array.from(new Set(dates.map(isoToMonth)));
      const baseMonth = months[0] || isoToMonth(fmt(new Date()));
      const m1 = baseMonth;
      const dt = new Date(m1+'-01');
      const m2 = fmt(addDays(new Date(dt.getFullYear(), dt.getMonth()+1, 1),0)).slice(0,7);

      const grid = qs('#shotsGrid');
      grid.innerHTML = '';
      for(const m of [m1, m2]){
        try{
          const data = await apiGet('calendar_screenshot', { month: m });
          if(data && data.ok && data.svgDataUrl){
            const wrap = document.createElement('div');
            wrap.innerHTML = `<div class="font-semibold mb-2">${m}</div><img class="border rounded" src="${data.svgDataUrl}" alt="calendar ${m}"/>`;
            grid.appendChild(wrap);
          }
        }catch(err){
          console.error(`Failed to load calendar for ${m}`, err);
          toast(`Failed to load calendar for ${m}: ${err.message}`);
        }
      }
      qs('#screenshots').classList.remove('hidden');
    }catch(err){
      console.error(err);
      toast('Failed to load calendar snapshots: '+err.message);
    }
  }

  async function saveDrivers(){
    let key = qs('#adminKey').value.trim(); if(!key && ADMIN_KEY){ key = ADMIN_KEY; } // may be empty if ADMIN_API_KEY not set
    // collect edits
    qsa('#driversTable [data-k]').forEach(inp=>{
      const i = +inp.dataset.i; const k = inp.dataset.k;
      let v = inp.type==='checkbox' ? inp.checked : inp.value;
      if(k === 'active'){ v = Boolean(v); }
      DRIVERS[i][k]=v;
    });
    const upserts = DRIVERS.map(d=>({
      driver_id: d.driver_id,
      display_name: d.display_name,
      category: d.category,
      active: d.active !== false
    }));
    try{
      const res = await apiPost('drivers_upsert', { admin_key: key, upserts });
      if(res.ok){
        toast('Drivers saved');
        await loadDrivers();
      }else{
        toast('Save failed: '+(res.message||''));
      }
    }catch(err){
      toast('Save failed: '+err.message);
    }
  }

  async function saveSettings(){
    let key = qs('#adminKey').value.trim(); if(!key && ADMIN_KEY){ key = ADMIN_KEY; }
    const body = { admin_key: key, calendar_id: 'a63b18e7b18d3291057cbcdb6c055d60f0d6d6fd399fac158b447dc88801f677@group.calendar.google.com'.trim(), weekend_days: qs('#weekendDays').value.trim() };
    try{
      const res = await apiPost('settings_save', body);
      if(res.ok){ toast('Settings saved'); } else { toast('Save failed: '+(res.message||'')); }
    }catch(err){
      toast('Save failed: '+err.message);
    }
  }

  // ====== EVENTS ======
  qs('#dateStart').addEventListener('change', e=>{ SELECTED.start = e.target.value; refreshCapacityHints();});
  qs('#dateEnd').addEventListener('change', e=>{ SELECTED.end = e.target.value; refreshCapacityHints();});
  qs('#btnSubmit').addEventListener('click', submitForm);
  qs('#toggleAdmin').addEventListener('click', ()=> qs('#adminBody').classList.toggle('hidden'));
  qs('#btnAddDriver').addEventListener('click', addDriverRow);
  qs('#btnSaveDrivers').addEventListener('click', saveDrivers);
  qs('#btnSaveSettings').addEventListener('click', saveSettings);
  qs('#btnReloadDrivers').addEventListener('click', async()=>{ await loadDrivers(); toast('Drivers reloaded'); });
  qs('#btnResetFromServer').addEventListener('click', async()=>{ await loadDrivers(); toast('Reloaded from server'); });

  qs('#btnCancelForce').addEventListener('click', ()=>{
    qs('#forceModal').classList.add('hidden');
    PENDING_FORCE_START = null;
  });
  qs('#btnConfirmForce').addEventListener('click', confirmForce);

  // INIT
  (async function(){ await loadDrivers(); })();
  </script>
</body>
</html>
